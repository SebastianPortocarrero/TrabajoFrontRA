# Story 1.1: Neon PostgreSQL Database Setup

## Status
Draft

## Story
**As a** development team implementing Better Auth integration,  
**I want** a configured Neon PostgreSQL database with proper connection setup and environment variables,  
**so that** we have the foundational database infrastructure ready for Better Auth without affecting existing localStorage functionality.

## Acceptance Criteria
1. Neon PostgreSQL database instance created and accessible
2. Database connection strings configured in environment variables
3. Connection testing validates database accessibility from Node.js backend
4. Environment setup supports both development and staging configurations
5. Database is ready for Better Auth schema creation (future story)
6. Zero impact on existing localStorage authentication functionality
7. Documentation created for database setup process

## Tasks / Subtasks

- [ ] Task 1: Create Neon Database Instance (AC: 1, 4)
  - [ ] Create Neon account and new project
  - [ ] Set up development database instance
  - [ ] Set up staging database branch (for future use)
  - [ ] Record database URLs and access credentials
  - [ ] Verify database is accessible via Neon dashboard

- [ ] Task 2: Configure Environment Variables (AC: 2, 4)
  - [ ] Add DATABASE_URL to .env files for both development and staging
  - [ ] Add NEON_PROJECT_ID environment variable
  - [ ] Create .env.example with template database configuration
  - [ ] Document environment variable requirements
  - [ ] Ensure .env files are properly gitignored

- [ ] Task 3: Install PostgreSQL Dependencies (AC: 3, 6)
  - [ ] Install pg (PostgreSQL client) in api-backend package
  - [ ] Install @types/pg for TypeScript support
  - [ ] Verify no conflicts with existing dependencies
  - [ ] Update package.json with new dependencies

- [ ] Task 4: Create Database Connection Module (AC: 3, 6)
  - [ ] Create utils/database/neonConnection.ts in api-backend
  - [ ] Implement connection pool configuration
  - [ ] Add connection testing function
  - [ ] Implement graceful connection handling
  - [ ] Add error handling for connection failures

- [ ] Task 5: Test Database Connectivity (AC: 3, 7)
  - [ ] Create test endpoint /api/db-test for connection verification
  - [ ] Test database connection from development environment
  - [ ] Verify connection pooling works correctly
  - [ ] Test error handling for connection failures
  - [ ] Document connection testing procedures

- [ ] Task 6: Create Documentation (AC: 7)
  - [ ] Document Neon database setup process
  - [ ] Create troubleshooting guide for connection issues
  - [ ] Document environment variable configuration
  - [ ] Add database setup to project README section

## Dev Notes

### Previous Story Insights
This is the first story in the Better Auth implementation plan. No previous Better Auth stories exist. This story establishes the foundational database infrastructure without affecting existing localStorage authentication functionality.

### Current Technology Stack Analysis
**Existing Backend Context** [Source: docs/architecture.md#tech-stack-alignment]:
- Express.js backend with Google Drive APIs
- Node.js environment with TypeScript support
- Existing development setup with api-backend directory
- No current PostgreSQL dependencies or database connections

### Neon PostgreSQL Integration Requirements
**Database Configuration** [Source: docs/BETTER_AUTH_NEON_IMPLEMENTATION_PLAN.md#phase-1]:
- PostgreSQL 14+ compatibility (Neon provides latest)
- Connection string format: `postgresql://username:password@host/database`
- Environment-based configuration for development/staging separation
- Connection pooling for performance optimization

**Zero Breaking Changes Requirement** [Source: docs/BETTER_AUTH_NEON_IMPLEMENTATION_PLAN.md#critical-requirements]:
- Database setup must not interfere with existing localStorage authentication
- New database connection isolated from current Google Drive functionality
- Parallel system implementation - no data migration required
- Existing API endpoints remain unchanged

### File Structure and Implementation Context
**Database Integration File Organization** [Source: docs/architecture.md#source-tree-integration]:
```
api-backend/
├── utils/
│   └── database/
│       ├── neonConnection.ts       # Neon PostgreSQL connection module
│       └── connectionTest.ts       # Database connectivity testing
├── .env                            # Development environment variables
├── .env.staging                    # Staging environment variables  
├── .env.example                    # Environment template
└── package.json                    # Updated with PostgreSQL dependencies
```

### Environment Configuration Requirements
**Environment Variables** [Source: docs/BETTER_AUTH_NEON_IMPLEMENTATION_PLAN.md#environment-setup]:
- `DATABASE_URL`: Full PostgreSQL connection string from Neon
- `NEON_PROJECT_ID`: Neon project identifier for management
- Development and staging environment separation
- Secure credential management following existing patterns

### Node.js Compatibility Requirements
**Technical Requirements** [Source: docs/BETTER_AUTH_NEON_IMPLEMENTATION_PLAN.md#technical-requirements]:
- Node.js 18+ compatibility (for Better Auth future integration)
- TypeScript support for database connection types
- PostgreSQL client library (pg) integration
- Connection pooling for production readiness

### Connection Security and Performance
**Security Configuration**:
- SSL/TLS connection to Neon database required
- Connection string security following environment variable best practices
- Error handling that doesn't expose connection details
- Graceful degradation if database unavailable

**Performance Configuration**:
- Connection pooling setup for multiple concurrent requests
- Connection timeout configuration
- Proper connection cleanup and resource management
- Health check endpoint for database monitoring

### Testing
**Database Testing Standards**:
- **Test File Location**: `utils/database/__tests__/` for connection testing
- **Testing Framework**: Jest for unit testing database connectivity
- **Integration Testing**: Test actual Neon database connection
- **Specific Requirements**: Connection testing must validate successful PostgreSQL connection without affecting existing localStorage auth functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation for Better Auth Epic 1.1 | SM Bob |